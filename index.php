<?php
// === CONFIG ===
$botToken  = "8311328395:AAFZn0ljyLwZu1mTOkMJMMgcsppufJ5g_JE";
$apiURL    = "https://api.telegram.org/bot$botToken/";
$owner     = "tradingrobots-web";
$repo2     = "ex5s"; // repo containin

// === FUNCTIONS ===
function send_msg($apiURL, $chat_id, $text, $keyboard = null) {
    $data = [
        'chat_id' => $chat_id,
        'text' => $text,
        'parse_mode' => 'Markdown'
    ];
    if ($keyboard) $data['reply_markup'] = json_encode($keyboard);

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $apiURL . "sendMessage");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_exec($ch);
    curl_close($ch);
}

function send_document($apiURL, $chat_id, $file_path, $caption = "") {
    $ch = curl_init();
    $cfile = new CURLFile(realpath($file_path));
    $data = [
        'chat_id' => $chat_id,
        'document' => $cfile,
        'caption' => $caption,
        'parse_mode' => 'Markdown'
    ];
    curl_setopt($ch, CURLOPT_URL, $apiURL . "sendDocument");
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_exec($ch);
    curl_close($ch);
}

// ‚úÖ Fixed version for large binary files
function github_download_file($owner, $repo, $path, $destination) {
    $url = "https://raw.githubusercontent.com/$owner/$repo/main/" . rawurlencode($path);

    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, true);
    curl_setopt($ch, CURLOPT_USERAGENT, "Mozilla/5.0");
    curl_setopt($ch, CURLOPT_HEADER, false);

    $data = curl_exec($ch);
    $status = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $contentType = curl_getinfo($ch, CURLINFO_CONTENT_TYPE);
    curl_close($ch);

    if ($status == 200 && strpos($contentType, 'text/html') === false) {
        file_put_contents($destination, $data, LOCK_EX);
        return true;
    }
    return false;
}

// === MAIN ===
$content = file_get_contents("php://input");
$update  = json_decode($content, true);
if (!$update) exit;

$chat_id = $update["message"]["chat"]["id"];
$text    = trim($update["message"]["text"] ?? "");

// === KEYBOARD ===
$mainKeyboard = [
    "keyboard" => [
        [["text" => "‚¨áÔ∏è Download Indicator & Script"]],
        [["text" => "‚¨ÖÔ∏è Back to Menu"]],
    ],
    "resize_keyboard" => true
];

// === START HANDLER ===
if ($text == "/start" || $text == "‚¨ÖÔ∏è Back to Menu") {
    send_msg($apiURL, $chat_id,
        "üëã *Welcome to KingDiv Tools!*\n\n"
      . "Tap the button below to download your latest *Indicator* and *Activator Script* files üì¶üëá",
        $mainKeyboard
    );
    exit;
}

// === DOWNLOAD HANDLER ===
if ($text == "‚¨áÔ∏è Download Indicator & Script") {
    $indicator_file = __DIR__ . "/Kingdiv V1 2025.ex5";
    $script_file    = __DIR__ . "/KingDiv_Activator_Script 2.ex5";

    if (!file_exists($indicator_file)) {
        github_download_file($owner, $repo2, "Kingdiv V1 2025.ex5", $indicator_file);
    }
    if (!file_exists($script_file)) {
        github_download_file($owner, $repo2, "KingDiv_Activator_Script 2.ex5", $script_file);
    }

    if (filesize($indicator_file) < 1000) {
    send_msg($apiURL, $chat_id,
        "‚ö†Ô∏è *Download Interrupted*\n\n"
      . "It seems your *Indicator file* didn‚Äôt download correctly.\n"
      . "Please tap again or retry in a few moments ‚Äî your premium tools are standing by."
    );
} else {
    send_document($apiURL, $chat_id, $indicator_file,
        "üìà *KingDiv V1 2025 Indicator* ‚Äî your *High-Precision Chart Analysis Engine.*\n\n"
      . "Built for *Forex*, *Volatility Indices*, and *Step Index* ‚Äî where milliseconds and micro-trends define the edge.\n\n"
      . "üíé *What Makes It Special:*\n"
      . "‚Ä¢ Institutional-grade chart analytics powered by adaptive logic ‚öôÔ∏è\n"
      . "‚Ä¢ Real-time bias detection for *trend confidence* üìä\n"
      . "‚Ä¢ Dynamic Support & Resistance channels auto-generated by market structure üîç\n"
      . "‚Ä¢ *No hidden settings. No coding. Plug, activate, and analyze instantly.*\n\n"
      . "When precision meets simplicity ‚Äî trading stops being guessing and becomes *execution.* üöÄ"
    );
}

if (filesize($script_file) < 1000) {
    send_msg($apiURL, $chat_id,
        "‚ö†Ô∏è *Activator Script Missing*\n\n"
      . "Your *Activation Script* didn‚Äôt finish downloading.\n"
      . "Please retry ‚Äî this script securely unlocks your KingDiv license."
    );
} else {
    send_document($apiURL, $chat_id, $script_file,
        "‚öôÔ∏è *KingDiv Activator Script 2* ‚Äî *Activate and Analyze Instantly.*\n\n"
      . "üîê Run it once in *MetaTrader ‚Üí Scripts* to bind your premium license to your verified Binance alias.\n\n"
      . "üí° After activation, your indicator automatically syncs ‚Äî ready to decode market structure and deliver precise signals in real time.\n\n"
      . "Designed for serious traders mastering *Forex*, *Volatility 75*, and *Step Index* movements ‚Äî where accuracy means profit.\n\n"
      . "Activate. Analyze. Dominate. üíº"
    );
}


    exit;
}
?>
